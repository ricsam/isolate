# 08-fs.md - @ricsam/isolate-fs Implementation Plan

## Overview

The fs package provides an OPFS-compatible File System Access API for the isolate.

## Implementation Steps

### 1. FileSystemDirectoryHandle
- [x] kind property ('directory')
- [x] name property
- [x] getFileHandle(name, options?) - { create: boolean }
- [x] getDirectoryHandle(name, options?)
- [x] removeEntry(name, options?) - { recursive: boolean }
- [x] resolve(possibleDescendant)
- [x] entries(), keys(), values() - async iterators
- [x] Symbol.asyncIterator support
- [x] isSameEntry(other)

### 2. FileSystemFileHandle
- [x] kind property ('file')
- [x] name property
- [x] getFile() - returns File
- [x] createWritable(options?) - returns FileSystemWritableFileStream
- [x] isSameEntry(other)

### 3. FileSystemWritableFileStream
- [x] write(data) - string, ArrayBuffer, TypedArray, Blob, or WriteParams
- [x] seek(position)
- [x] truncate(size)
- [x] close()
- [x] abort(reason)
- [x] locked property

### 4. navigator.storage Integration
- [x] navigator.storage.getDirectory() - returns root OPFS directory

### 5. Host Handler Interface
- [x] Define FileSystemHandler interface
- [x] All operations proxy to host via callbacks
- [x] Host implements actual file system (real FS, in-memory, etc.)

## Implementation Notes

All file system operations are async and must be proxied to the host. The handler pattern allows flexible backends:
- Real file system access via Node.js fs
- In-memory file system for testing
- Browser OPFS for web environments

## Test Coverage

- `index.test.ts` - 25 tests passing
- MockFileSystem in-memory implementation for testing

### Tests Implemented

- **FileSystemDirectoryHandle** (8 tests): getFileHandle creates/opens file, getDirectoryHandle creates directory, removeEntry removes file/directory, entries/keys/values iteration
- **FileSystemFileHandle** (2 tests): getFile returns File, createWritable returns WritableStream
- **FileSystemWritableFileStream** (6 tests): write string/ArrayBuffer, write at position, seek, truncate, close
- **streaming** (2 tests): stream() returns ReadableStream, read file in chunks
- **error handling** (3 tests): NotFoundError, InvalidModificationError
- **isSameEntry** (2 tests): same file, different files
- **resolve** (2 tests): path components for descendant, null for non-descendant

## Dependencies

- `@ricsam/isolate-core`
- `isolated-vm`
